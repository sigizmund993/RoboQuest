<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/48/000000/python.png">
    <title>Z-IDE Pro</title>
    <script src="js/blockly.min.js"></script>
    <script src="js/python_compressed.js"></script>
    <!-- <script src="js/blocks_compressed.js"></script> -->
    <script src="js/ru.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --acc: #58a6ff;
            --brd: #30363d;
            --green: #238636;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--bg);
            color: #c9d1d9;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            padding: 10px 20px;
            background: var(--panel);
            border-bottom: 1px solid var(--brd);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .main {
            display: flex;
            flex: 1;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        #blocklyDiv {
            flex: 2;
            border-radius: 8px;
            border: 1px solid var(--brd);
        }

        .code-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--panel);
            border-radius: 8px;
            border: 1px solid var(--brd);
        }

        #codeOutput {
            margin: 0;
            padding: 15px;
            flex: 1;
            overflow: auto;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            color: #79c0ff;
            line-height: 1.5;
        }

        .btns {
            display: flex;
            gap: 8px;
        }

        button {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid var(--brd);
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        button:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        button.primary {
            background: var(--green);
            color: white;
            border: none;
        }

        #status {
            font-size: 11px;
            color: #8b949e;
        }
    </style>
</head>

<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <span style="color:var(--acc); font-weight:bold; font-size:18px;">ULTIMATE PATRIOTIK IDE</span>
            <div id="status">● Ожидание...</div>
        </div>
        <div class="btns">
            <button onclick="saveBlocks()">Сохранить проект</button>
            <button onclick="loadBlocks()">Открыть проект</button>
            <button id="btnBind">Привязать .py файл</button>
            <button class="primary" onclick="runOnPc()">ЗАПУСТИТЬ</button>
        </div>
    </header>

    <div class="main">
        <div id="blocklyDiv"></div>
        <!-- <div class="code-zone">
            <div style="padding: 5px 15px; font-size: 10px; color: #8b949e; border-bottom: 1px solid var(--brd);">
                GENERATED_CODE</div>
            <pre id="codeOutput"></pre>
        </div> -->
    </div>

    <xml id="toolbox" style="display: none">
        <category name="Логика" colour="#5b80a5">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
        </category>
        <category name="Циклы" colour="#5ba55b">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for"></block>
        </category>
        <category name="Математика" colour="#5b67a5">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
        </category>
        <category name="Переменные" colour="#a55b80" custom="VARIABLE"></category>
        <category name="Функции" colour="#995ba5" custom="PROCEDURE"></category>
        <category name="Геометрия" colour="#0d8d94">
            <block type="create_point"></block>
            <block type="point_arithmetic"></block>
            <block type="point_scale"></block>
            <block type="point_get"></block>
            <block type="dist"></block>
            <block type="is_ball_in_zone"></block>
        </category>
        <category name="игровые объекты" colour="#5b0669">
            <block type="robot_get_pos"></block>
            <block type="ball"></block>
            <block type="ally_goal"></block>
            <block type="enemy_goal"></block>
            <block type="defend_point"></block>

        </category>
        <category name="Команды роботам" colour="#695506">
            <block type="strategy_wrapper"></block>
            <block type="kick"></block>
            <block type="go"></block>

        </category>

    </xml>

    <script>
        let fileHandle;
        const statusEl = document.getElementById('status');

        Blockly.Blocks['robot_get_pos'] = {
            init: function () {
                this.appendDummyInput().appendField("положение робота номер");
                this.appendValueInput("id").setCheck("Number");
                this.setOutput(true, "Point"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['robot_get_pos'] = function (block) {
            const id = Blockly.Python.valueToCode(block, 'id', Blockly.Python.ORDER_ATOMIC);
            return [`field.allies[${id}].get_pos()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['ball'] = {
            init: function () {
                this.appendDummyInput().appendField("мяч");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['ball'] = function (block) {
            return [`field.ball.get_pos()`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['ally_goal'] = {
            init: function () {
                this.appendDummyInput().appendField("свои ворота");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['ally_goal'] = function (block) {
            return [`field.ally_goal.center`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['defend_point'] = {
            init: function () {
                this.appendDummyInput().appendField("точка для защиты");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['defend_point'] = function (block) {
            return [`goalk_func.calc_gk_position(field,field.active_allies(False))[0]`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['enemy_goal'] = {
            init: function () {
                this.appendDummyInput().appendField("вражеские ворота");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['enemy_goal'] = function (block) {
            return [`field.enemy_goal.center`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['create_point'] = {
            init: function () {
                this.appendDummyInput().appendField("точка(");
                this.appendValueInput("X").setCheck("Number");
                this.appendDummyInput().appendField(",");
                this.appendValueInput("Y").setCheck("Number");
                this.appendDummyInput().appendField(")");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#0d8d94");
            }
        };
        Blockly.Python.forBlock['create_point'] = function (block) {
            const x = Blockly.Python.valueToCode(block, 'X', Blockly.Python.ORDER_ATOMIC) || '0';
            const y = Blockly.Python.valueToCode(block, 'Y', Blockly.Python.ORDER_ATOMIC) || '0';
            return [`aux.Point(${x}, ${y})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['point_arithmetic'] = {
            init: function () {
                this.appendValueInput("A").setCheck("Point");
                this.appendDummyInput().appendField(new Blockly.FieldDropdown([["+", "ADD"], ["-", "SUB"]]), "OP");
                this.appendValueInput("B").setCheck("Point");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#0d8d94");
            }
        };
        Blockly.Python.forBlock['point_arithmetic'] = function (block) {
            const a = Blockly.Python.valueToCode(block, 'A', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            const b = Blockly.Python.valueToCode(block, 'B', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            const op = block.getFieldValue('OP') === 'ADD' ? '+' : '-';
            return [`${a} ${op} ${b}`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['point_scale'] = {
            init: function () {
                this.appendValueInput("P").setCheck("Point");
                this.appendDummyInput().appendField("*");
                this.appendValueInput("N").setCheck("Number");
                this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#0d8d94");
            }
        };
        Blockly.Python.forBlock['point_scale'] = function (block) {
            const p = Blockly.Python.valueToCode(block, 'P', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            const n = Blockly.Python.valueToCode(block, 'N', Blockly.Python.ORDER_ATOMIC) || '1';
            return [`${p} * ${n}`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['point_get'] = {
            init: function () {
                this.appendValueInput("P").setCheck("Point");
                this.appendDummyInput().appendField(".").appendField(new Blockly.FieldDropdown([["x", "X"], ["y", "Y"]]), "COORD");
                this.setOutput(true, "Number"); this.setColour("#0d8d94");
            }
        };
        Blockly.Python.forBlock['point_get'] = function (block) {
            const p = Blockly.Python.valueToCode(block, 'P', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            const coord = block.getFieldValue('COORD').toLowerCase();
            return [`${p}.${coord}`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['dist'] = {
            init: function () {
                this.appendDummyInput().appendField("расстояние между");
                this.appendValueInput("P1").setCheck("Point");
                this.appendDummyInput().appendField("и");
                this.appendValueInput("P2").setCheck("Point");
                this.setOutput(true, "Number"); this.setColour("#0d8d94");
            }
        };
        Blockly.Python.forBlock['dist'] = function (block) {
            const p1 = Blockly.Python.valueToCode(block, 'P1', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            const p2 = Blockly.Python.valueToCode(block, 'P2', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            return [`aux.dist(${p1},${p2})`, Blockly.Python.ORDER_ATOMIC];
        };

        Blockly.Blocks['kick'] = {
            init: function () {
                this.appendValueInput("id").setCheck("Number").appendField("робот номер");
                this.appendValueInput("POINT").setCheck("Point").appendField("бей в");
                this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#695506");
            }
        };
        Blockly.Python.forBlock['kick'] = function (block) {
            const id = Blockly.Python.valueToCode(block, 'id', Blockly.Python.ORDER_ATOMIC) || '0';
            const pt = Blockly.Python.valueToCode(block, 'POINT', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            return 'actions[' + id + '] = Actions.Kick( ' + pt + ')\n';
        };

        Blockly.Blocks['go'] = {
            init: function () {
                this.appendValueInput("id").setCheck("Number").appendField("робот номер");
                this.appendValueInput("POINT").setCheck("Point").appendField("едь в");
                this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#695506");
            }
        };
        Blockly.Python.forBlock['go'] = function (block) {
            const id = Blockly.Python.valueToCode(block, 'id', Blockly.Python.ORDER_ATOMIC) || '0';
            const pt = Blockly.Python.valueToCode(block, 'POINT', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
            return 'actions[' + id + '] = Actions.GoToPoint( ' + pt + ',aux.angle_to_point(field.allies[' + id + '].get_pos(),field.ball.get_pos()))\n';

        };

        Blockly.Blocks['strategy_wrapper'] = {
            init: function () {
                this.appendDummyInput().appendField("главный цикл программы");
                this.appendStatementInput("STACK").setCheck(null);
                this.setColour("#995ba5");
                this.setTooltip("Поместите команды внутрь этого блока");
            }
        };
        Blockly.Python.forBlock['strategy_wrapper'] = function (block) {
            const branch = Blockly.Python.statementToCode(block, 'STACK');
            const code = branch || Blockly.Python.INDENT + 'pass\n';
            return 'def debug(self: Strategy, field: fld.Field, actions: list[Action]) -> None:\n' + code;
        };
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            theme: Blockly.Theme.defineTheme('dark', {
                'base': Blockly.Themes.Classic,
                'componentStyles': { 'workspaceBackgroundColour': '#0d1117', 'toolboxBackgroundColour': '#161b22', 'toolboxTextColour': '#c9d1d9', 'flyoutBackgroundColour': '#0d1117' }
            }),
            grid: { spacing: 20, length: 3, colour: '#21262d', snap: true }
        });

        Blockly.Blocks['is_ball_in_zone'] = {
            init: function () {
                this.appendDummyInput().appendField("мяч в зоне");
                this.setInputsInline(true); this.setOutput(true, "Boolean"); this.setColour("#5b0669");
            }
        };
        Blockly.Python.forBlock['is_ball_in_zone'] = function (block) {
            return [`aux.is_point_inside_poly(field.ball.get_pos(),field.ally_goal.big_hull)`, Blockly.Python.ORDER_ATOMIC];
        };
        const pyHeader = "# mypy: ignore-errors\nfrom bridge import const\nfrom bridge.auxiliary import aux, fld, rbt\nfrom bridge.const import State as GameStates\nfrom bridge.router.base_actions import Action, Actions, KickActions\nfrom bridge.strategy import attack_roles, defense_roles, goalk_func, ref_states, tests, attacker_func\nfrom bridge.strategy.strategy import Strategy\n";
        //"def debug(self: Strategy, field: fld.Field, actions: list[Action]) -> None:\n"
        const pyEnder = "Strategy.debug = debug"
        async function update() {
            const code = pyHeader + Blockly.Python.workspaceToCode(workspace) + pyEnder;
            document.getElementById('codeOutput').innerText = code;
            if (fileHandle) {
                try {
                    const writable = await fileHandle.createWritable();
                    await writable.write(code);
                    await writable.close();
                } catch (e) { }
            }
        }
        workspace.addChangeListener(update);
        function saveBlocks() {
            const data = JSON.stringify(Blockly.serialization.workspaces.save(workspace));
            const blob = new Blob([data], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'project.json'; a.click();
        }
        function loadBlocks() {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => Blockly.serialization.workspaces.load(JSON.parse(ev.target.result), workspace);
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }
        document.getElementById('btnBind').onclick = async () => {
            [fileHandle] = await window.showOpenFilePicker();
            statusEl.innerText = "● Файл привязан"; statusEl.style.color = "#3fb950";
            update();
        };
        function runOnPc() { fetch('/run').catch(() => alert("Ошибка сервера")); }
    </script>
</body>

</html>