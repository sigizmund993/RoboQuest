<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Z-IDE Professional</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b0e14; --panel: #151921; --acc: #00f2ff; --brd: #2d333f; }
        body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #e0e6ed; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 12px 20px; background: var(--panel); border-bottom: 1px solid var(--brd); display: flex; align-items: center; justify-content: space-between; }
        .main { display: flex; flex: 1; padding: 10px; gap: 10px; overflow: hidden; }
        #blocklyDiv { flex: 2; border-radius: 8px; border: 1px solid var(--brd); }
        .code-zone { flex: 1; display: flex; flex-direction: column; background: var(--panel); border-radius: 8px; border: 1px solid var(--brd); }
        #codeOutput { margin: 0; padding: 15px; flex: 1; overflow: auto; font-family: 'Fira Code', monospace; font-size: 13px; color: #a5d6ff; line-height: 1.5; }
        .btns { display: flex; gap: 10px; }
        button { background: #232936; color: white; border: 1px solid var(--brd); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px; }
        button:hover { background: #2d3545; border-color: var(--acc); }
        button.primary { background: var(--acc); color: #000; border: none; }
        #status { font-size: 12px; color: #888; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:20px;">
        <span style="color:var(--acc); font-weight:bold; letter-spacing:1px;">Z-IDE v2.0</span>
        <div id="status">● Файл не выбран</div>
    </div>
    <div class="btns">
        <button id="btnBind">1. ВЫБРАТЬ ФАЙЛ (.py)</button>
        <button class="primary" onclick="runOnPc()">2. ЗАПУСТИТЬ</button>
    </div>
</header>

<div class="main">
    <div id="blocklyDiv"></div>
    <div class="code-zone">
        <div style="padding: 8px 15px; font-size: 10px; color: #555; border-bottom: 1px solid var(--brd);">GENERATED_PYTHON_SOURCE</div>
        <pre id="codeOutput"></pre>
    </div>
</div>

<xml id="toolbox" style="display: none">
    <category name="Математика" colour="#5b67a5">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
    </category>
    <category name="Z-Геометрия" colour="#995ba5">
        <block type="create_point"></block>
        <block type="block_z"></block>
    </category>
    <category name="Переменные" colour="#a55b80" custom="VARIABLE"></category>
</xml>

<script>
    let fileHandle;
    const statusEl = document.getElementById('status');

    // Определение блоков
    Blockly.Blocks['create_point'] = {
        init: function() {
            this.appendDummyInput().appendField("Point(");
            this.appendValueInput("X").setCheck("Number");
            this.appendDummyInput().appendField(",");
            this.appendValueInput("Y").setCheck("Number");
            this.appendDummyInput().appendField(")");
            this.setInputsInline(true); this.setOutput(true, "Point"); this.setColour("#995ba5");
        }
    };
    Blockly.Blocks['block_z'] = {
        init: function() {
            this.appendDummyInput().appendField("Z_FUNC");
            this.appendValueInput("ID").setCheck("Number").appendField("id:");
            this.appendValueInput("POINT").setCheck("Point").appendField("pos:");
            this.setInputsInline(true); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour("#00f2ff");
        }
    };

    // Генераторы кода
    Blockly.Python['create_point'] = function(block) {
        let x = Blockly.Python.valueToCode(block, 'X', Blockly.Python.ORDER_ATOMIC) || '0';
        let y = Blockly.Python.valueToCode(block, 'Y', Blockly.Python.ORDER_ATOMIC) || '0';
        return [`Point(${x}, ${y})`, Blockly.Python.ORDER_ATOMIC];
    };
    Blockly.Python['block_z'] = function(block) {
        let id = Blockly.Python.valueToCode(block, 'ID', Blockly.Python.ORDER_ATOMIC) || '0';
        let pt = Blockly.Python.valueToCode(block, 'POINT', Blockly.Python.ORDER_ATOMIC) || 'Point(0,0)';
        return `Z(${id}, ${pt})\n`;
    };

    const workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        theme: Blockly.Themes.Dark,
        grid: {spacing: 20, length: 3, colour: '#1d232d', snap: true}
    });

    const headerText = `import time\n\nclass Point:\n    def __init__(self,x,y): self.x,self.y=x,y\n    def __repr__(self): return f"P({self.x},{self.y})"\n\ndef Z(id_val, pt):\n    print(f"Executing Z: ID={id_val} at {pt}")\n    return pt\n\n# --- BEGIN ---\n`;

    async function update() {
        const code = headerText + Blockly.Python.workspaceToCode(workspace);
        document.getElementById('codeOutput').innerText = code;
        
        if (fileHandle) {
            try {
                const writable = await fileHandle.createWritable();
                await writable.write(code);
                await writable.close();
                statusEl.innerText = "● Файл синхронизирован";
                statusEl.style.color = "#00f2ff";
            } catch (e) {
                statusEl.innerText = "● Ошибка записи!";
                statusEl.style.color = "red";
            }
        }
    }
    workspace.addChangeListener(update);

    document.getElementById('btnBind').onclick = async () => {
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{ description: 'Python file', accept: {'text/python': ['.py']} }]
            });
            statusEl.innerText = "● Связь установлена";
            update();
        } catch (e) { alert("Используйте Chrome/Edge или запустите через http://localhost:5000"); }
    };

    function runOnPc() {
        fetch('/run').then(r => r.json()).then(d => {
            if(d.status !== "Success") alert("Ошибка сервера");
        }).catch(() => alert("Сервер server.py не запущен!"));
    }
</script>
</body>
</html>